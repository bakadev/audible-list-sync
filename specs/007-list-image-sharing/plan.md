# Implementation Plan: List Image Generation, Templates, S3 Upload, and Sharing

**Branch**: `007-list-image-sharing` | **Date**: 2026-02-21 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/007-list-image-sharing/spec.md`

## Summary

Add automated image generation to the List creation and update flow. When users create or edit a list, they select an image template that places book cover images into predefined slots. On save, the server generates OG (1200x630) and Square (1080x1080) PNG images using Satori (JSX→SVG) and Resvg (SVG→PNG), uploads them to S3 with app-level versioning, and stores S3 keys in the database. The public list view displays the generated header image, includes OG meta tags for social previews, and provides a Share modal with copy link, image downloads, and social platform share shortcuts.

## Technical Context

**Language/Version**: TypeScript 5.x (strict mode) + Next.js 16 (App Router), React 19, Prisma 6
**Primary Dependencies**: satori (^0.19.2), @resvg/resvg-js (^2.6.2), @aws-sdk/client-s3 (^3.x), @aws-sdk/s3-request-presigner (^3.x), Inter font TTF files
**Storage**: PostgreSQL 14+ (via Prisma — new fields on existing List model), AWS S3 (`audioshlf-lists` bucket, private, app-level versioning)
**Testing**: Manual testing via social media debug tools (X Card Validator, Facebook Sharing Debugger, LinkedIn Post Inspector)
**Target Platform**: Node.js runtime (required for native @resvg/resvg-js, fs.readFile font loading, AWS SDK)
**Project Type**: Web application (monorepo, packages/ui is the target package)
**Performance Goals**: Image generation < 5 seconds per list (2 sizes). Cover fetch concurrency: 4-6 parallel. Font loading cached at module scope.
**Constraints**: S3 bucket is private (signed URLs for serving). OG images served via proxy route with 302 redirect. Regeneration cooldown: 30 seconds per list.
**Scale/Scope**: Affects ~8 existing files, creates ~15 new files. 3 initial templates. 2 new API routes, 3 modified API routes.

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### I. Security & Privacy First — PASS
- No user credentials involved. S3 credentials are server-side only (env vars).
- Generated images contain only public list data (title, book covers, username).
- OG image proxy route is public but only serves list images that users chose to make public.

### II. Package-Based Architecture — PASS
- All changes within `packages/ui` (the web application package).
- New modules (`lib/image-generator/`, `lib/s3.ts`) are cleanly separated with single responsibilities.
- No cross-package dependencies introduced.

### III. Data Normalization & Efficiency — PASS
- Image metadata stored on the existing `List` model (not duplicated).
- S3 keys stored, not full URLs — allows base URL changes without migration.
- Template registry is application-level code, not stored in DB (avoids unnecessary table).

### IV. Responsible External System Integration — PASS
- Cover image fetching limited to 4-6 concurrent requests with timeouts.
- S3 uploads use standard SDK with proper error handling.
- Failed generation does NOT prevent list save — graceful degradation.
- Regeneration cooldown (30s) prevents abuse.

### V. User Control & Transparency — PASS
- Users choose their template (not auto-assigned).
- Image generation status shown in UI (NONE/GENERATING/READY/FAILED).
- Failed generation shows error with retry option.
- Share modal gives users control over how they share (copy link, download, social platforms).

### Post-Design Re-check — PASS
- S3 keys use app-level versioning for reliable social media cache busting.
- OG image proxy route avoids exposing signed URLs in meta tags.
- All new API endpoints follow existing auth patterns.

## Project Structure

### Documentation (this feature)

```text
specs/007-list-image-sharing/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Phase 0: Technology research and decisions
├── data-model.md        # Phase 1: Schema changes and state transitions
├── quickstart.md        # Phase 1: Setup and development guide
├── contracts/
│   └── api.md           # Phase 1: API endpoint contracts
└── tasks.md             # Phase 2: Implementation tasks (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
packages/ui/
├── fonts/
│   ├── Inter-Regular.ttf              # Satori font (server-only, NOT in public/)
│   └── Inter-Bold.ttf                 # Satori font (server-only)
├── src/
│   ├── app/
│   │   ├── api/
│   │   │   ├── lists/
│   │   │   │   ├── [listId]/
│   │   │   │   │   ├── route.ts               # MODIFIED: include image fields in response
│   │   │   │   │   ├── og-image/route.ts       # NEW: OG image proxy (302 → signed S3 URL)
│   │   │   │   │   ├── square-image/route.ts   # NEW: Square image proxy
│   │   │   │   │   └── regenerate-images/route.ts  # NEW: Manual regeneration
│   │   │   │   └── route.ts                    # MODIFIED: accept imageTemplateId
│   │   │   └── templates/route.ts              # NEW: Template registry endpoint
│   │   └── [username]/
│   │       └── lists/[listId]/page.tsx          # MODIFIED: OG metadata + header image
│   ├── components/
│   │   └── lists/
│   │       ├── template-picker.tsx             # NEW: Template selection + preview
│   │       ├── share-modal.tsx                 # NEW: Share dialog with social links
│   │       ├── list-image-header.tsx           # NEW: Generated image display in list view
│   │       ├── create-list-form.tsx            # MODIFIED: template picker integration
│   │       └── edit-list-client.tsx            # MODIFIED: template picker + regenerate
│   └── lib/
│       ├── image-generator/
│       │   ├── presets.ts                      # NEW: SIZE_PRESETS constant
│       │   ├── covers.ts                       # NEW: Fetch covers, base64 encode
│       │   ├── render.ts                       # NEW: Satori SVG + Resvg PNG pipeline
│       │   ├── fonts.ts                        # NEW: Font loader with module-scope cache
│       │   ├── generateListImages.ts           # NEW: Orchestrator
│       │   └── templates/
│       │       ├── registry.ts                 # NEW: Template registry + types
│       │       ├── grid-3x3.tsx                # NEW: Grid 3x3 template component
│       │       ├── hero.tsx                    # NEW: Hero layout template
│       │       └── minimal-banner.tsx          # NEW: Minimal banner template
│       ├── s3.ts                               # NEW: S3 client singleton, upload, signed URLs
│       └── share.ts                            # NEW: Social share URL generator
├── prisma/
│   └── schema.prisma                           # MODIFIED: ImageStatus enum + List image fields
└── next.config.ts                              # MODIFIED: serverExternalPackages
```

**Structure Decision**: All changes are within the existing `packages/ui` package. New server-side modules (`lib/image-generator/`, `lib/s3.ts`) follow the established pattern of placing utilities in `src/lib/`. Templates are React components in `lib/image-generator/templates/` because they are server-side rendering components (not UI components), and must be Satori-compatible (no hooks, flexbox-only).

## Complexity Tracking

No constitution violations. All design decisions align with existing patterns and principles.
